name: 'Run TW Next Smoke Tests against production'
on:
  schedule:
    - cron: '0 14,17,20,23 * * 1-5' # 8am, 11am, 2pm, 5pm CST M-F
    - cron: '0 14,23 * * 0,6' # 8am 5pm CST Sun and Saturday
  workflow_dispatch:

jobs:
  smoke-tests:
    runs-on: ubuntu-latest-8-cores
    concurrency:
      group: twnext-smoke-tests
      cancel-in-progress: true
    env:
      NODE_AUTH_TOKEN: ${{secrets.PACKAGES_READ_TOKEN}}
      TOKEN_FOR_GITHUB: ${{secrets.PACKAGES_READ_TOKEN}}
      TEST_ACCOUNT: development
      TEST_URL: https://www.tailwindapp.com/
      CI: true
      GANDALF_CLIENT_ID: qa
      GANDALF_CLIENT_SECRET: ${{secrets.GANDALF_CLIENT_SECRET}}
      MAILOSAUR_KEY: ${{secrets.MAILOSAUR_KEY}}
      TEXTGEARS_KEY: ${{secrets.TEXTGEARS_KEY}}
      PINTEREST_TOKEN: ${{secrets.PINTEREST_TOKEN}}
      INSTAGRAM_TOKEN: ${{secrets.PINTEREST_TOKEN}}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: './test/playwright/.nvmrc'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@tailwind'
          cache: 'npm'
          cache-dependency-path: './test/playwright/package-lock.json'

      - name: Install playwright dependencies
        run: |
          npm ci || npm ci
          npx playwright install
          npx playwright install-deps
        working-directory: 'test/playwright'

      - name: Run Smoke Tests
        timeout-minutes: 40
        run: npm run test -- -g @SMOKE
        continue-on-error: true
        working-directory: 'test/playwright'
        id: run-smoke-tests

      - name: Rerun Failed Tests
        timeout-minutes: 40
        if: steps.run-smoke-tests.outcome == 'failure'
        id: rerun-failed-tests
        run: npm run test:failed
        working-directory: 'test/playwright'

      - name: Get timestamp
        if: always()
        id: timestamp
        run: echo "timestamp=$(date +'%Y-%m-%d-%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: twnext-smoke-playwright-report_${{ steps.timestamp.outputs.timestamp }}
          path: test/playwright/playwright-report
          retention-days: 3

      - name: run teardown routines on qa
        timeout-minutes: 20
        run: npm run test -- -g @TEARDOWN
        env:
          TEST_URL: https://qa_twnext_deploy-www.tailwindapp.com/
        working-directory: 'test/playwright'
        continue-on-error: true
        if: always()

      - name: Alert on test failure
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,message,action,eventName,ref,workflow,job,took # selectable (default: repo,message)
          custom_payload: |
            {
              username: 'TW Next SMOKE scheduled test failure',
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                text: `${process.env.AS_WORKFLOW}\n${process.env.AS_JOB} ${{ job.status }} in ${process.env.AS_TOOK}`,
              }]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_E2E_ALERTS_WEBHOOK }}
        if: failure() && (steps.rerun-failed-tests.outcome == 'failure' || steps.rerun-failed-tests.outcome == 'skipped')
